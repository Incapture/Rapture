/**
 * Copyright (C) 2011-2013 Incapture Technologies LLC
 *
 * This is an autogenerated license statement. When copyright notices appear below
 * this one that copyright supercedes this statement.
 *
 * Unless required by applicable law or agreed to in writing, software is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied.
 *
 * Unless explicit permission obtained in writing this software cannot be distributed.
 */


returnVal = true;

doc_repo_name = "documentPartition.reflexVersionTest"+ rand(1000000);
CONFIG = 'NREP {} using MONGODB { prefix=doc_repo_name }';
FOUNTAIN_CFG = 'IDGEN { base="26",length="20", prefix="TST"} USING MONGODB {prefix="reflexVersionTest"+rand(1000000)}';
DOCUMENT_REPO_URI = 'document://'+ doc_repo_name;


println ('Create ' + DOCUMENT_REPO_URI);
if (!(#doc.docRepoExists(DOCUMENT_REPO_URI))) do
	#doc.createDocRepo(DOCUMENT_REPO_URI, CONFIG);
end
#doc.setDocRepoIdGenConfig(DOCUMENT_REPO_URI, FOUNTAIN_CFG);

println ('Testing versioning with docs');
DOC_URI=DOCUMENT_REPO_URI + '/folder/doc'+rand(10);
acctDocContent = '{"key": "value"}';
putDataModified = '{"key1": "value1"}';

putContent=#doc.putDoc(DOC_URI, acctDocContent);
putContent=#doc.putDoc(DOC_URI, acctDocContent);
dmd=#doc.getDocAndMeta(DOC_URI);
if !(dmd['metaData']['version']== 1) do
	returnVal = false;
	println('metadata version is not 1, setting to false');
end

putUpdateContent = #doc.putDoc(DOC_URI, putDataModified);
docmd = #doc.getDocAndMeta(DOC_URI);

if !(docmd['metaData']['version']==2) do
   returnVal = false;
   println('version is not 2, setting to false');
end

//In the same doc repo now add content to another document
DOC_REVERT_URI=DOCUMENT_REPO_URI + '/folder/doc'+rand(1000000000);
putContentForAnotherDoc=#doc.putDoc(DOC_REVERT_URI, acctDocContent);
putContentAgain=#doc.putDoc(DOC_REVERT_URI, acctDocContent);

dmdForOtherDoc=#doc.getDocAndMeta(DOC_REVERT_URI);

if !(dmdForOtherDoc['metaData']['version']==1) do
    returnVal = false;
end

//Delete repo
#doc.deleteDocRepo(DOCUMENT_REPO_URI);

return returnVal;