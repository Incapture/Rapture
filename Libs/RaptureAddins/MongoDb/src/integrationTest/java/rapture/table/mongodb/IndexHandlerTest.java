/**
 * Copyright (C) 2011-2015 Incapture Technologies LLC
 *
 * This is an autogenerated license statement. When copyright notices appear below
 * this one that copyright supercedes this statement.
 *
 * Unless required by applicable law or agreed to in writing, software is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied.
 *
 * Unless explicit permission obtained in writing this software cannot be distributed.
 */
package rapture.table.mongodb;

import java.util.HashMap;
import java.util.Map;

import org.junit.Test;

import rapture.common.TableQueryResult;
import rapture.dsl.idef.IndexDefinition;
import rapture.dsl.idef.IndexDefinitionFactory;
import rapture.index.IndexProducer;

/**
 * Query a table
 * 
 * @author amkimian
 *
 */
public class IndexHandlerTest {
	@Test
	public void testQuery() {
		MongoIndexHandler table = new MongoIndexHandler();
		table.setInstanceName("default");
		Map<String, String> config = new HashMap<String, String>();
		config.put("prefix", "tableTest");
		table.setConfig(config);
		
		//IndexDefinition iDef = new IndexDefinition();
		IndexDefinition iDef  = IndexDefinitionFactory.getDefinition("tradeDate($0) string, tradeId($1) string, idField(id) string, fundField(fund) string, sideField(side) string");

		IndexProducer indexProducer = new IndexProducer();
		indexProducer.addIndexDefinition(iDef);

		table.setIndexProducer(indexProducer);
		
		Map<String, Object> cellVals = new HashMap<String, Object>();
		cellVals.put("tradeDate", "20131212");
		cellVals.put("tradeId", "ID1");
		cellVals.put("idField", "ID1id");
		cellVals.put("fundField", "FUND");
		cellVals.put("sideField", "BUY");
		table.updateRow("default", cellVals);
		cellVals.put("tradeDate", "20131213");
		cellVals.put("tradeId", "ID2");
		table.updateRow("default", cellVals);
		
		String qry1 = "SELECT tradeDate, tradeId";
		
		//dumpQuery(table, qry1);
		
		dumpQuery(table, "SELECT DISTINCT tradeDate, tradeId");
	}

	private void dumpQuery(MongoIndexHandler table, String qry1) {
		TableQueryResult res = table.query(qry1);
		System.out.println("Column names " + res.getColumnNames());
		System.out.println("Column types " + res.getColumnTypes());
		System.out.println("Rows " + res.getRows());
	}
}
